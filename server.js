const y=require("express"),x=require("http"),{WebSocketServer:E}=require("ws"),d=require("multer"),b=require("path"),{v4:N}=require("uuid"),O=require("archiver"),j=require("adm-zip"),z=require("esbuild"),M=require("csso"),v=require("sass"),C=require("less"),$=require("stylus"),{minify:P}=require("html-minifier-terser"),{parse:D,print:J}=require("graphql"),T=require("yaml"),L=require("sql-minifier"),A=require("luamin"),I=require("php-parser"),S=require("strip-comments"),{GlslMinify:F}=require("webpack-glsl-minify"),m=y(),k=x.createServer(m),R=new E({server:k}),G=d({storage:d.memoryStorage()}),w=3e3,h=new Map;R.on("connection",a=>{const c=N();h.set(c,a),a.send(JSON.stringify({type:"welcome",clientId:c})),a.on("close",()=>h.delete(c))});function W(a,c,s){const e=h.get(a);e&&e.readyState===e.OPEN&&e.send(JSON.stringify({type:c,payload:s}))}const q=new I({parser:{extractDoc:!1,suppressErrors:!0},lexer:{all_tokens:!0}}),B=F;function _(a){return a.split(`
`).map(c=>c.replace(/#.*$|--.*$|%.*$/,"").trim()).filter(c=>c.length>0).join(`
`)}async function H(a,c){const s=async o=>{try{return(await z.build({stdin:{contents:a,loader:c},write:!1,bundle:!1,minify:!0,...o})).outputFiles[0].text}catch{return null}};let e=await s({format:"esm"});return e||(e=await s({format:"cjs"})),e||(console.warn(`Giving up on minifying snippet with loader '${c}'. Keeping original.`),a)}async function Q(a,c){try{const s=a.toString("utf8");let e;switch(c){case".js":case".mjs":case".cjs":case".ts":case".mts":case".cts":case".jsx":case".tsx":e=await H(s,c.substring(1));break;case".css":e=M.minify(s).css;break;case".scss":e=v.compileString(s,{style:"compressed"}).css;break;case".sass":e=v.compileString(s,{style:"compressed",syntax:"indented"}).css;break;case".less":e=(await C.render(s,{compress:!0})).css;break;case".styl":e=await new Promise((r,l)=>$(s).set("compress",!0).render((u,f)=>u?l(u):r(f)));break;case".html":case".htm":case".xhtml":e=await P(s,{removeComments:!0,collapseWhitespace:!0,minifyJS:!0,minifyCSS:!0,sortAttributes:!0,sortClassName:!0});break;case".xml":case".svg":case".xsd":case".xsl":case".xslt":case".qml":e=await P(s,{xmlMode:!0,collapseWhitespace:!0,removeComments:!0});break;case".json":e=JSON.stringify(JSON.parse(s));break;case".jsonc":e=JSON.stringify(JSON.parse(S(s)));break;case".jsonl":e=s.split(/\r?\n/).filter(r=>r.trim().length>0).map(r=>JSON.stringify(JSON.parse(r))).join(`
`);break;case".yaml":case".yml":e=JSON.stringify(T.parse(s));break;case".gql":case".graphql":e=J(D(s));break;case".sql":case".hql":case".plsql":case".tsql":case".cyp":case".cypher":e=L.minify(s);break;case".php":case".phtml":e=q.unparse(q.parseCode(s));break;case".lua":e=A.minify(s);break;case".glsl":case".vert":case".frag":case".geom":case".hlsl":case".fx":case".shader":e=(await B.execute(s)).sourceCode;break;case".c":case".h":case".cpp":case".cc":case".cxx":case".hpp":case".hh":case".cs":case".csx":case".java":case".go":case".rs":case".swift":case".kt":case".kts":case".d":case".m":case".mm":case".vala":case".scala":case".sc":case".groovy":case".gd":case".py":case".pyw":case".pyi":case".rb":case".rbw":case".pl":case".pm":case".sh":case".bash":case".zsh":case".fish":case".ps1":case".r":case".jl":case".sas":case".v":case".sv":case".svh":case".vhd":case".vhdl":case".el":case".lisp":case".lsp":case".cl":case".scm":case".ss":case".re":case".rei":e=S(s);break;case"dockerfile":case".dockerignore":case".conf":case".cfg":case".ini":case".toml":case".hcl":case".tf":case".tfvars":case".gitignore":case".gitattributes":case".pp":case".cr":case".nim":case".fth":case".tex":case".ltx":case".sty":case".cls":e=_(s);break;case".bf":case".b":e=s.replace(/[^><+\-.,[\]]/g,"");break;default:return a}if(typeof e!="string")return a;const o=Buffer.from(e,"utf8");return o.length<a.length?o:a}catch(s){return console.error(`Error minifying ${c} (falling back to original):`,s.message),a}}m.use(y.static("public")),m.post("/upload",G.any(),async(a,c)=>{const{clientId:s,projectName:e="project"}=a.body;let o=a.body.relativePaths?JSON.parse(a.body.relativePaths):[];const r=[];a.files.forEach((t,n)=>{t.mimetype==="application/zip"||b.extname(t.originalname).toLowerCase()===".zip"?new j(t.buffer).getEntries().forEach(i=>{i.isDirectory||r.push({relativePath:i.entryName,buffer:i.getData()})}):r.push({relativePath:o[n]||t.originalname,buffer:t.buffer})}),console.log(`
--- [STEP\xA01] RAW FILE PATHS RECEIVED FROM UPLOAD ---`),r.forEach(t=>console.log(t.relativePath)),console.log(`---------------------------------------------------
`);let l="";if(r.length>1){const t=r[0].relativePath.split("/");for(let n=0;n<t.length-1;n++){const p=t.slice(0,n+1).join("/");if(r.every(i=>i.relativePath.startsWith(p+"/")))l=p+"/";else break}}l&&(console.log(`--- [STEP\xA02] DETECTED COMMON PREFIX: "${l}" ---
`),r.forEach(t=>t.relativePath=t.relativePath.slice(l.length)));const u=`${e.replace(/[^a-z0-9]/gi,"_").toLowerCase()}_minified.zip`;c.set({"Content-Type":"application/zip","Content-Disposition":`attachment; filename="${u}"`});const f=O("zip",{zlib:{level:9}});f.pipe(c),console.log("--- [STEP\xA03] FINAL PATHS BEING ADDED TO ZIP ---");for(const t of r){const n=t.relativePath.includes(".")?b.extname(t.relativePath).toLowerCase():t.relativePath.toLowerCase(),p=t.buffer.length,i=await Q(t.buffer,n);f.append(i,{name:t.relativePath});const g=i.length;console.log(`Processed: "${t.relativePath}" | ${p} -> ${g} bytes`),W(s,"file-processed",{fileName:t.relativePath,originalSize:p,minifiedSize:g})}console.log(`-----------------------------------------------
`),await f.finalize()}),k.listen(w,()=>{console.log(`\u{1F680} Universal Minifier running at http://localhost:${w}`)});
