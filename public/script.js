document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("upload-form"),t=document.getElementById("submit-btn"),n=document.getElementById("button-text"),s=document.getElementById("file-upload"),o=document.getElementById("folder-upload"),i=document.getElementById("projectName"),l=document.getElementById("clientId"),a=document.getElementById("status-indicator"),d=document.getElementById("connection-status"),r=document.getElementById("file-list"),c=document.getElementById("file-items"),m=document.getElementById("folder-info"),p=document.getElementById("folder-details"),u=document.querySelector("main"),g=document.getElementById("results-container"),f=document.getElementById("results-log"),y=document.getElementById("summary"),h=document.getElementById("progress-fill"),v=document.getElementById("files-processed"),b=document.getElementById("compression-ratio"),x=document.getElementById("bytes-saved");let E={totalFiles:0,processedFiles:0,totalOriginalSize:0,totalMinifiedSize:0,isProcessing:!1};const L=()=>{E={totalFiles:0,processedFiles:0,totalOriginalSize:0,totalMinifiedSize:0,isProcessing:!1}},w=(e,t=2)=>{if(0===e)return"0 B";const n=Math.floor(Math.log(e)/Math.log(1024));return`${parseFloat((e/Math.pow(1024,n)).toFixed(t))} ${["B","KB","MB","GB"][n]}`},I=()=>{u.classList.remove("hidden"),g.classList.add("hidden"),r.classList.add("hidden"),m.classList.add("hidden"),c.innerHTML="",p.innerHTML="";const e=s.closest(".space-y-4").parentElement,i=o.closest(".space-y-4").parentElement;e.classList.remove("opacity-50","pointer-events-none"),i.classList.remove("opacity-50","pointer-events-none"),s.disabled=!1,o.disabled=!1,t.disabled=!l.value,n.innerHTML=l.value?"Minify & Download":"Connecting..."},B=()=>{const{totalFiles:t,processedFiles:n,totalOriginalSize:s,totalMinifiedSize:o}=E,i=t>0?n/t*100:0;h.style.width=`${i}%`,v.textContent=`${n} / ${t}`;const l=s-o;x.textContent=w(l);const a=s>0?l/s*100:0;if(b.textContent=`${a.toFixed(1)}%`,y.innerHTML=`<div class="text-neon-blue font-medium">Processing file ${n} of ${t}...</div>`,n===t&&t>0){y.innerHTML=`\n        <strong class="text-neon-green text-xl">Optimization Complete!</strong>\n        <p class="text-gray-300 mt-2">Total savings: <strong>${w(l)}</strong> (${a.toFixed(1)}%) across ${t} files.</p>\n        <p class="text-gray-400 text-sm mt-2">Your download has started. Click below to start over.</p>\n      `;const n=document.createElement("button");n.textContent="Minify More Files",n.className="btn-cyber px-6 py-2 mt-4 bg-gradient-to-r from-neon-blue to-neon-purple text-white font-bold rounded-lg transition-transform hover:scale-105",n.onclick=()=>{e.reset(),L(),I()},y.appendChild(n)}},M="https:"===window.location.protocol?"wss:":"ws:",$=new WebSocket(`${M}//${window.location.host}`);$.onopen=()=>{d.textContent="Connection Established",a.classList.replace("status-connecting","status-connected"),t.disabled=!1,n.innerHTML="Minify & Download"},$.onmessage=e=>{const t=JSON.parse(e.data);"welcome"===t.type?l.value=t.clientId:"file-processed"===t.type&&E.isProcessing&&(E.processedFiles++,E.totalOriginalSize+=t.payload.originalSize,E.totalMinifiedSize+=t.payload.minifiedSize,(({fileName:e,originalSize:t,minifiedSize:n})=>{const s=t-n,o=t>0?s/t*100:0,i=document.createElement("li");i.className="glass-morphism rounded-lg p-3 flex justify-between items-center text-sm animate__animated animate__fadeInUp animate__faster",i.innerHTML=`\n      <span class="font-mono text-gray-300 break-all pr-4">${e}</span>\n      <span class="text-right text-xs whitespace-nowrap">\n        ${w(t)} â†’ ${w(n)}\n        <span class="font-bold ml-2 w-16 inline-block text-right ${s>0?"text-neon-green":"text-neon-yellow"}">\n          ${o.toFixed(1)}%\n        </span>\n      </span>`,f.appendChild(i),f.scrollTop=f.scrollHeight})(t.payload),B())},$.onclose=()=>{d.textContent="Connection Lost",a.classList.replace("status-connected","status-error"),t.disabled=!0,n.textContent="Disconnected"};const S=e=>{if(E.isProcessing)return;I();const t="file-upload"===e.target.id,n=s.closest(".space-y-4").parentElement,i=o.closest(".space-y-4").parentElement;if(t&&s.files.length>0)i.classList.add("opacity-50","pointer-events-none"),o.disabled=!0,r.classList.remove("hidden"),c.innerHTML=Array.from(s.files).map(e=>`<div class="text-gray-300 text-sm truncate">${e.name}</div>`).join("");else if(!t&&o.files.length>0){n.classList.add("opacity-50","pointer-events-none"),s.disabled=!0,m.classList.remove("hidden");const e=o.files.length,t=o.files[0].webkitRelativePath.split("/")[0]||"Selected Folder";p.innerHTML=`<p class="text-gray-300">${e} files in <span class="font-semibold text-white">${t}</span></p>`}};s.addEventListener("change",S),o.addEventListener("change",S),e.addEventListener("submit",async e=>{if(e.preventDefault(),!l.value)return void alert("Establishing secure connection. Please wait.");const t=s.files.length?s.files:o.files;if(0===t.length)return void alert("Please select files or a folder to minify.");L(),E.totalFiles=t.length,E.isProcessing=!0,u.classList.add("hidden"),g.classList.remove("hidden"),f.innerHTML="",B();const n=new FormData;n.append("clientId",l.value);const d=i.value||"minified-project";n.append("projectName",d);const r=[];for(const e of t)n.append("files[]",e,e.name),e.webkitRelativePath&&r.push(e.webkitRelativePath);r.length>0&&n.append("relativePaths",JSON.stringify(r));try{const e=await fetch("/upload",{method:"POST",body:n});if(!e.ok)throw new Error(`Server error: ${e.statusText}`);const t=await e.blob(),s=e.headers.get("Content-Disposition"),o=s?.match(/filename="(.+?)"/)?.[1]||`${d}.zip`,i=document.createElement("a");i.href=URL.createObjectURL(t),i.download=o,document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(i.href)}catch(e){y.innerHTML=`<strong class="text-neon-pink">Error:</strong> ${e.message}`,a.classList.add("status-error"),E.isProcessing=!1}}),setInterval(()=>{document.querySelectorAll("a").forEach(e=>{"relative"!=e.style.position&&(e.style.position="relative"),"9999"!=e.style.zIndex&&(e.style.zIndex="9999"),"auto"!=e.style.pointerEvents&&(e.style.pointerEvents="auto"),"pointer"!=e.style.cursor&&(e.style.cursor="pointer")})},0)});