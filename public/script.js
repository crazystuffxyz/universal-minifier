document.addEventListener("DOMContentLoaded",()=>{const x=document.getElementById("upload-form"),y=document.getElementById("submit-btn"),h=document.getElementById("button-text"),l=document.getElementById("file-upload"),r=document.getElementById("folder-upload"),T=document.getElementById("projectName"),d=document.getElementById("clientId"),v=document.getElementById("status-indicator"),E=document.getElementById("connection-status"),L=document.getElementById("file-list"),I=document.getElementById("file-items"),w=document.getElementById("folder-info"),B=document.getElementById("folder-details"),M=document.querySelector("main"),C=document.getElementById("results-container"),p=document.getElementById("results-log"),f=document.getElementById("summary"),U=document.getElementById("progress-fill"),H=document.getElementById("files-processed"),D=document.getElementById("compression-ratio"),O=document.getElementById("bytes-saved");let a={totalFiles:0,processedFiles:0,totalOriginalSize:0,totalMinifiedSize:0,isProcessing:!1};const S=()=>{a={totalFiles:0,processedFiles:0,totalOriginalSize:0,totalMinifiedSize:0,isProcessing:!1}},u=(e,t=2)=>{if(e===0)return"0 B";const s=1024,o=Math.floor(Math.log(e)/Math.log(s));return`${parseFloat((e/Math.pow(s,o)).toFixed(t))} ${["B","KB","MB","GB"][o]}`},$=()=>{M.classList.remove("hidden"),C.classList.add("hidden"),L.classList.add("hidden"),w.classList.add("hidden"),I.innerHTML="",B.innerHTML="";const e=l.closest(".space-y-4").parentElement,t=r.closest(".space-y-4").parentElement;e.classList.remove("opacity-50","pointer-events-none"),t.classList.remove("opacity-50","pointer-events-none"),l.disabled=!1,r.disabled=!1,y.disabled=!d.value,h.innerHTML=d.value?"Minify & Download":"Connecting..."},F=()=>{const{totalFiles:e,processedFiles:t,totalOriginalSize:s,totalMinifiedSize:o}=a,i=e>0?t/e*100:0;U.style.width=`${i}%`,H.textContent=`${t} / ${e}`;const n=s-o;O.textContent=u(n);const g=s>0?n/s*100:0;if(D.textContent=`${g.toFixed(1)}%`,f.innerHTML=`<div class="text-neon-blue font-medium">Processing file ${t} of ${e}...</div>`,t===e&&e>0){f.innerHTML=`
        <strong class="text-neon-green text-xl">Optimization Complete!</strong>
        <p class="text-gray-300 mt-2">Total savings: <strong>${u(n)}</strong> (${g.toFixed(1)}%) across ${e} files.</p>
        <p class="text-gray-400 text-sm mt-2">Your download has started. Click below to start over.</p>
      `;const m=document.createElement("button");m.textContent="Minify More Files",m.className="btn-cyber px-6 py-2 mt-4 bg-gradient-to-r from-neon-blue to-neon-purple text-white font-bold rounded-lg transition-transform hover:scale-105",m.onclick=()=>{x.reset(),S(),$()},f.appendChild(m)}},z=({fileName:e,originalSize:t,minifiedSize:s})=>{const o=t-s,i=t>0?o/t*100:0,n=document.createElement("li");n.className="glass-morphism rounded-lg p-3 flex justify-between items-center text-sm animate__animated animate__fadeInUp animate__faster",n.innerHTML=`
      <span class="font-mono text-gray-300 break-all pr-4">${e}</span>
      <span class="text-right text-xs whitespace-nowrap">
        ${u(t)} \u2192 ${u(s)}
        <span class="font-bold ml-2 w-16 inline-block text-right ${o>0?"text-neon-green":"text-neon-yellow"}">
          ${i.toFixed(1)}%
        </span>
      </span>`,p.appendChild(n),p.scrollTop=p.scrollHeight},j=window.location.protocol==="https:"?"wss:":"ws:",b=new WebSocket(`${j}//${window.location.host}`);b.onopen=()=>{E.textContent="Connection Established",v.classList.replace("status-connecting","status-connected"),y.disabled=!1,h.innerHTML="Minify & Download"},b.onmessage=e=>{const t=JSON.parse(e.data);t.type==="welcome"?d.value=t.clientId:t.type==="file-processed"&&a.isProcessing&&(a.processedFiles++,a.totalOriginalSize+=t.payload.originalSize,a.totalMinifiedSize+=t.payload.minifiedSize,z(t.payload),F())},b.onclose=()=>{E.textContent="Connection Lost",v.classList.replace("status-connected","status-error"),y.disabled=!0,h.textContent="Disconnected"};const P=e=>{if(a.isProcessing)return;$();const t=e.target.id==="file-upload",s=l.closest(".space-y-4").parentElement,o=r.closest(".space-y-4").parentElement;if(t&&l.files.length>0)o.classList.add("opacity-50","pointer-events-none"),r.disabled=!0,L.classList.remove("hidden"),I.innerHTML=Array.from(l.files).map(i=>`<div class="text-gray-300 text-sm truncate">${i.name}</div>`).join("");else if(!t&&r.files.length>0){s.classList.add("opacity-50","pointer-events-none"),l.disabled=!0,w.classList.remove("hidden");const i=r.files.length,n=r.files[0].webkitRelativePath.split("/")[0]||"Selected Folder";B.innerHTML=`<p class="text-gray-300">${i} files in <span class="font-semibold text-white">${n}</span></p>`}};l.addEventListener("change",P),r.addEventListener("change",P),x.addEventListener("submit",async e=>{if(e.preventDefault(),!d.value){alert("Establishing secure connection. Please wait.");return}const t=l.files.length?l.files:r.files;if(t.length===0){alert("Please select files or a folder to minify.");return}S(),a.totalFiles=t.length,a.isProcessing=!0,M.classList.add("hidden"),C.classList.remove("hidden"),p.innerHTML="",F();const s=new FormData;s.append("clientId",d.value);const o=T.value||"minified-project";s.append("projectName",o);const i=[];for(const n of t)s.append("files[]",n,n.name),n.webkitRelativePath&&i.push(n.webkitRelativePath);i.length>0&&s.append("relativePaths",JSON.stringify(i));try{const n=await fetch("/upload",{method:"POST",body:s});if(!n.ok)throw new Error(`Server error: ${n.statusText}`);const g=await n.blob(),R=n.headers.get("Content-Disposition")?.match(/filename="(.+?)"/)?.[1]||`${o}.zip`,c=document.createElement("a");c.href=URL.createObjectURL(g),c.download=R,document.body.appendChild(c),c.click(),document.body.removeChild(c),URL.revokeObjectURL(c.href)}catch(n){f.innerHTML=`<strong class="text-neon-pink">Error:</strong> ${n.message}`,v.classList.add("status-error"),a.isProcessing=!1}}),setInterval(()=>{document.querySelectorAll("a").forEach(e=>{e.style.position!="relative"&&(e.style.position="relative"),e.style.zIndex!="9999"&&(e.style.zIndex="9999"),e.style.pointerEvents!="auto"&&(e.style.pointerEvents="auto"),e.style.cursor!="pointer"&&(e.style.cursor="pointer")})},0)});
